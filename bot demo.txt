import logging
import json
import os
import asyncio
import random
import smtplib
import ssl
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from datetime import datetime, timedelta
from typing import Dict, Any, Optional
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    MessageHandler,
    filters,
    ContextTypes,
)

logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

INFINITE_RATING = float('inf')

# –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
ADMIN_IDS = [int(id) for id in os.environ.get("ADMIN_IDS", "").split(",") if id]
BOT_TOKEN = os.environ.get("BOT_TOKEN", "")

DATA_FILE = "bot_data.json"
ANIMALS_FILE = "animals.json"
ACHIEVEMENTS_FILE = "achievements.json"
BANNED_USERS_FILE = "banned_users.json"
PUNISHMENTS_FILE = "punishments.json"
CUSTOM_RULES_FILE = "custom_rules.json"
SAVE_INTERVAL = 25

EMAIL_CONFIG = {
    "smtp_server": os.environ.get("SMTP_SERVER", "smtp.gmail.com"),
    "smtp_port": int(os.environ.get("SMTP_PORT", "587")),
    "sender_email": os.environ.get("SENDER_EMAIL", ""),
    "sender_password": os.environ.get("SENDER_PASSWORD", ""),
    "recipient_email": os.environ.get("RECIPIENT_EMAIL", "")
}

DEFAULT_RULES = {
    "spam": {"name": "–°–ø–∞–º", "penalty": 10, "description": "–ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π"},
    "insult": {"name": "–û—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è", "penalty": 20, "description": "–û—Å–∫–æ—Ä–±–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"},
    "advert": {"name": "–†–µ–∫–ª–∞–º–∞", "penalty": 30, "description": "–ù–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–µ–∫–ª–∞–º–∞"},
    "flood": {"name": "–§–ª—É–¥", "penalty": 5, "description": "–ú–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–¥—Ä—è–¥"},
    "nsfw": {"name": "NSFW –∫–æ–Ω—Ç–µ–Ω—Ç", "penalty": 50, "description": "–ó–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç"},
    "offtopic": {"name": "–û—Ñ—Ñ—Ç–æ–ø", "penalty": 3, "description": "–°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –ø–æ —Ç–µ–º–µ"},
    "caps": {"name": "–ö–∞–ø—Å", "penalty": 2, "description": "–ú–Ω–æ–≥–æ –∑–∞–≥–ª–∞–≤–Ω—ã—Ö –±—É–∫–≤"}
}

ANIMALS = {
    "—Å–≤–∏–Ω–∫–∞": {
        "name": "üê∑ –°–≤–∏–Ω–∫–∞",
        "rarity_weights": {
            "–û–±—ã—á–Ω–∞—è": 40,
            "–ù–µ–æ–±—ã—á–Ω–∞—è": 30,
            "–†–µ–¥–∫–∞—è": 20,
            "–≠–ø–∏—á–µ—Å–∫–∞—è": 7,
            "–ú–∏—Ñ–∏—á–µ—Å–∫–∞—è": 3
        },
        "base_income": 3,
        "emoji": "üê∑"
    },
    "–∫–æ—Ç–∏–∫": {
        "name": "üê± –ö–æ—Ç–∏–∫",
        "rarity_weights": {
            "–û–±—ã—á–Ω–∞—è": 35,
            "–ù–µ–æ–±—ã—á–Ω–∞—è": 30,
            "–†–µ–¥–∫–∞—è": 22,
            "–≠–ø–∏—á–µ—Å–∫–∞—è": 9,
            "–ú–∏—Ñ–∏—á–µ—Å–∫–∞—è": 4
        },
        "base_income": 4,
        "emoji": "üê±"
    },
    "—è—â–µ—Ä–∏—Ü–∞": {
        "name": "ü¶é –Ø—â–µ—Ä–∏—Ü–∞",
        "rarity_weights": {
            "–û–±—ã—á–Ω–∞—è": 30,
            "–ù–µ–æ–±—ã—á–Ω–∞—è": 25,
            "–†–µ–¥–∫–∞—è": 25,
            "–≠–ø–∏—á–µ—Å–∫–∞—è": 15,
            "–ú–∏—Ñ–∏—á–µ—Å–∫–∞—è": 5
        },
        "base_income": 5,
        "emoji": "ü¶é"
    }
}

RARITY_MULTIPLIERS = {
    "–û–±—ã—á–Ω–∞—è": 1,
    "–ù–µ–æ–±—ã—á–Ω–∞—è": 2,
    "–†–µ–¥–∫–∞—è": 3,
    "–≠–ø–∏—á–µ—Å–∫–∞—è": 5,
    "–ú–∏—Ñ–∏—á–µ—Å–∫–∞—è": 8
}

RARITY_COLORS = {
    "–û–±—ã—á–Ω–∞—è": "‚ö™Ô∏è",
    "–ù–µ–æ–±—ã—á–Ω–∞—è": "üü¢",
    "–†–µ–¥–∫–∞—è": "üîµ",
    "–≠–ø–∏—á–µ—Å–∫–∞—è": "üü£",
    "–ú–∏—Ñ–∏—á–µ—Å–∫–∞—è": "üü°"
}

FARM_ACHIEVEMENTS = {
    "first_animal": {
        "name": "üê£ –ù–∞—á–∏–Ω–∞—é—â–∏–π —Ñ–µ—Ä–º–µ—Ä",
        "desc": "–ü–æ–ª—É—á–∏—Ç—å –ø–µ—Ä–≤–æ–µ –∂–∏–≤–æ—Ç–Ω–æ–µ",
        "reward": 5
    },
    "five_animals": {
        "name": "üå± –ó–æ–æ–ª—é–±–∏—Ç–µ–ª—å",
        "desc": "–°–æ–±—Ä–∞—Ç—å 5 –∂–∏–≤–æ—Ç–Ω—ã—Ö",
        "reward": 10
    },
    "ten_animals": {
        "name": "üåø –§–µ—Ä–º–µ—Ä-–ª—é–±–∏—Ç–µ–ª—å",
        "desc": "–°–æ–±—Ä–∞—Ç—å 10 –∂–∏–≤–æ—Ç–Ω—ã—Ö",
        "reward": 20
    },
    "twenty_animals": {
        "name": "üå≥ –û–ø—ã—Ç–Ω—ã–π —Ñ–µ—Ä–º–µ—Ä",
        "desc": "–°–æ–±—Ä–∞—Ç—å 20 –∂–∏–≤–æ—Ç–Ω—ã—Ö",
        "reward": 30
    },
    "rare_collector": {
        "name": "üíé –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä",
        "desc": "–°–æ–±—Ä–∞—Ç—å 3 —Ä–µ–¥–∫–∏—Ö –∂–∏–≤–æ—Ç–Ω—ã—Ö",
        "reward": 15
    },
    "epic_collector": {
        "name": "‚ú® –°–æ–±–∏—Ä–∞—Ç–µ–ª—å –ª–µ–≥–µ–Ω–¥",
        "desc": "–°–æ–±—Ä–∞—Ç—å 2 —ç–ø–∏—á–µ—Å–∫–∏—Ö –∂–∏–≤–æ—Ç–Ω—ã—Ö",
        "reward": 30
    },
    "mythic_collector": {
        "name": "üëë –ü–æ–≤–µ–ª–∏—Ç–µ–ª—å –º–∏—Ñ–æ–≤",
        "desc": "–ü–æ–ª—É—á–∏—Ç—å –º–∏—Ñ–∏—á–µ—Å–∫–æ–µ –∂–∏–≤–æ—Ç–Ω–æ–µ",
        "reward": 50
    },
    "full_house": {
        "name": "üé™ –ü–æ–ª–Ω—ã–π –¥–≤–æ—Ä",
        "desc": "–ò–º–µ—Ç—å –≤—Å–µ—Ö –≤–∏–¥–æ–≤ –∂–∏–≤–æ—Ç–Ω—ã—Ö",
        "reward": 40
    },
    "first_exchange": {
        "name": "üí± –ü–µ—Ä–≤–∞—è —Å–¥–µ–ª–∫–∞",
        "desc": "–û–±–º–µ–Ω—è—Ç—å –≤–∞–ª—é—Ç—É –Ω–∞ —Ä–µ–π—Ç–∏–Ω–≥",
        "reward": 5
    }
}

class SocialRatingBot:
    def __init__(self) -> None:
        self.users_db: Dict[str, Dict[str, Any]] = {}
        self.animals_db: Dict[str, Dict[str, Any]] = {}
        self.achievements_db: Dict[str, Dict[str, Any]] = {}
        self.banned_users: Dict[str, Dict[str, Any]] = {}
        self.punishments_db: Dict[str, list] = {}
        self.custom_rules_db: Dict[str, Dict[str, Any]] = {}
        self.pending_actions: Dict[str, Dict[str, Any]] = {}
        self.load_data()
        self.load_animals()
        self.load_achievements()
        self.load_banned_users()
        self.load_punishments()
        self.load_custom_rules()
        
    def load_data(self) -> None:
        if os.path.exists(DATA_FILE):
            try:
                with open(DATA_FILE, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                    self.users_db = data.get('users', {})
                logger.info(f"üìä –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã: {len(self.users_db)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: {e}")

    def load_animals(self) -> None:
        if os.path.exists(ANIMALS_FILE):
            try:
                with open(ANIMALS_FILE, 'r', encoding='utf-8') as f:
                    self.animals_db = json.load(f)
                logger.info(f"üêæ –ñ–∏–≤–æ—Ç–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã: {len(self.animals_db)} –∏–≥—Ä–æ–∫–æ–≤")
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∂–∏–≤–æ—Ç–Ω—ã—Ö: {e}")

    def load_achievements(self) -> None:
        if os.path.exists(ACHIEVEMENTS_FILE):
            try:
                with open(ACHIEVEMENTS_FILE, 'r', encoding='utf-8') as f:
                    self.achievements_db = json.load(f)
                logger.info(f"üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã: {len(self.achievements_db)} –∏–≥—Ä–æ–∫–æ–≤")
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π: {e}")

    def load_banned_users(self) -> None:
        if os.path.exists(BANNED_USERS_FILE):
            try:
                with open(BANNED_USERS_FILE, 'r', encoding='utf-8') as f:
                    self.banned_users = json.load(f)
                logger.info(f"üö´ –ó–∞–±–∞–Ω–µ–Ω–æ: {len(self.banned_users)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–Ω–æ–≤: {e}")

    def load_punishments(self) -> None:
        if os.path.exists(PUNISHMENTS_FILE):
            try:
                with open(PUNISHMENTS_FILE, 'r', encoding='utf-8') as f:
                    self.punishments_db = json.load(f)
                logger.info(f"‚öñÔ∏è –ò—Å—Ç–æ—Ä–∏—è –Ω–∞–∫–∞–∑–∞–Ω–∏–π: {len(self.punishments_db)} –∑–∞–ø–∏—Å–µ–π")
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞–∫–∞–∑–∞–Ω–∏–π: {e}")

    def load_custom_rules(self) -> None:
        if os.path.exists(CUSTOM_RULES_FILE):
            try:
                with open(CUSTOM_RULES_FILE, 'r', encoding='utf-8') as f:
                    self.custom_rules_db = json.load(f)
                logger.info(f"üìù –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–∞–≤–∏–ª: {len(self.custom_rules_db)}")
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∞–≤–∏–ª: {e}")

    def save_data(self) -> None:
        try:
            with open(DATA_FILE, 'w', encoding='utf-8') as f:
                json.dump({'users': self.users_db}, f, ensure_ascii=False, indent=2)
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: {e}")

    def save_animals(self) -> None:
        try:
            with open(ANIMALS_FILE, 'w', encoding='utf-8') as f:
                json.dump(self.animals_db, f, ensure_ascii=False, indent=2)
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∂–∏–≤–æ—Ç–Ω—ã—Ö: {e}")

    def save_achievements(self) -> None:
        try:
            with open(ACHIEVEMENTS_FILE, 'w', encoding='utf-8') as f:
                json.dump(self.achievements_db, f, ensure_ascii=False, indent=2)
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π: {e}")

    def save_banned_users(self) -> None:
        try:
            with open(BANNED_USERS_FILE, 'w', encoding='utf-8') as f:
                json.dump(self.banned_users, f, ensure_ascii=False, indent=2)
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±–∞–Ω–æ–≤: {e}")

    def save_punishments(self) -> None:
        try:
            with open(PUNISHMENTS_FILE, 'w', encoding='utf-8') as f:
                json.dump(self.punishments_db, f, ensure_ascii=False, indent=2)
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞–∫–∞–∑–∞–Ω–∏–π: {e}")

    def save_custom_rules(self) -> None:
        try:
            with open(CUSTOM_RULES_FILE, 'w', encoding='utf-8') as f:
                json.dump(self.custom_rules_db, f, ensure_ascii=False, indent=2)
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª: {e}")

    async def save_all_async(self) -> None:
        await asyncio.sleep(0.1)
        loop = asyncio.get_event_loop()
        await loop.run_in_executor(None, self.save_data)
        await loop.run_in_executor(None, self.save_animals)
        await loop.run_in_executor(None, self.save_achievements)
        await loop.run_in_executor(None, self.save_banned_users)
        await loop.run_in_executor(None, self.save_punishments)
        await loop.run_in_executor(None, self.save_custom_rules)

    def init_user(self, user_id: int, username: str = None, first_name: str = None) -> None:
        user_id = str(user_id)
        
        if user_id not in self.users_db:
            self.users_db[user_id] = {
                "rating": 0,
                "farm_currency": 0,
                "messages": 0,
                "username": username,
                "first_name": first_name,
                "last_active": datetime.now().timestamp(),
                "daily_bonus": None,
                "total_exchanged": 0,
                "total_punishments": 0,
                "last_punishment": None
            }
        else:
            user = self.users_db[user_id]
            if "farm_currency" not in user:
                user["farm_currency"] = 0
            if "total_exchanged" not in user:
                user["total_exchanged"] = 0
            if "total_punishments" not in user:
                user["total_punishments"] = 0

        if user_id not in self.animals_db:
            self.animals_db[user_id] = {
                "inventory": {},
                "last_collect": None
            }

        if user_id not in self.achievements_db:
            self.achievements_db[user_id] = {
                "completed": [],
                "stats": {
                    "animals_collected": 0,
                    "rare_animals": 0,
                    "epic_animals": 0,
                    "mythic_animals": 0,
                    "total_exchanged": 0,
                    "unique_animals": []
                }
            }

    def get_all_rules(self) -> Dict:
        all_rules = DEFAULT_RULES.copy()
        all_rules.update(self.custom_rules_db)
        return all_rules

    def get_rarity(self, animal_type: str) -> str:
        weights = ANIMALS[animal_type]["rarity_weights"]
        return random.choices(list(weights.keys()), weights=list(weights.values()))[0]

    def calculate_income(self, user_id: str) -> int:
        if user_id not in self.animals_db:
            return 0
        inventory = self.animals_db[user_id].get("inventory", {})
        total_income = 0
        for animal_type, data in inventory.items():
            base_income = ANIMALS[animal_type]["base_income"]
            for rarity, count in data.get("by_rarity", {}).items():
                multiplier = RARITY_MULTIPLIERS.get(rarity, 1)
                total_income += base_income * multiplier * count
        return total_income

    def is_admin(self, user_id: int) -> bool:
        return user_id in ADMIN_IDS

    def is_banned(self, user_id: int) -> bool:
        return str(user_id) in self.banned_users

    async def check_admin(self, update: Update) -> bool:
        user = update.effective_user
        if not user or not self.is_admin(user.id):
            await self.safe_edit(update, "‚õîÔ∏è –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏.", self.get_back_button())
            return False
        return True

    async def safe_edit(self, update: Update, text: str, reply_markup: Optional[InlineKeyboardMarkup] = None) -> None:
        try:
            if update.callback_query:
                await update.callback_query.message.edit_text(text, reply_markup=reply_markup)
            elif update.message:
                await update.message.reply_text(text, reply_markup=reply_markup)
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: {e}")

    def get_back_button(self, back_to: str = "main") -> InlineKeyboardMarkup:
        keyboard = [[InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"back_to_{back_to}")]]
        return InlineKeyboardMarkup(keyboard)

    async def show_main_menu(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        user = update.effective_user
        if not user:
            return

        if self.is_banned(user.id):
            ban_info = self.banned_users.get(str(user.id), {})
            reason = ban_info.get("reason", "–ù–µ —É–∫–∞–∑–∞–Ω–∞")
            await self.safe_edit(update, f"üö´ –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã!\n–ü—Ä–∏—á–∏–Ω–∞: {reason}", None)
            return

        self.init_user(user.id, user.username, user.first_name)
        is_admin = self.is_admin(user.id)

        keyboard = [
            [InlineKeyboardButton("‚≠êÔ∏è –ú–æ–π —Ä–µ–π—Ç–∏–Ω–≥", callback_data="rating")],
            [InlineKeyboardButton("üåæ –ú–æ—è —Ñ–µ—Ä–º–∞", callback_data="farm")],
            [InlineKeyboardButton("üí∞ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å", callback_data="daily_bonus")],
            [InlineKeyboardButton("üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è", callback_data="achievements")]
        ]

        if is_admin:
            keyboard.append([InlineKeyboardButton("üëë –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å", callback_data="admin")])

        welcome_text = (
            f"üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å{', –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' if is_admin else ''} {user.first_name}!\n\n"
            f"üêæ –ù–∞ —Ñ–µ—Ä–º–µ –º–æ–∂–Ω–æ —Å–æ–±–∏—Ä–∞—Ç—å –∂–∏–≤–æ—Ç–Ω—ã—Ö —Ä–∞–∑–Ω–æ–π —Ä–µ–¥–∫–æ—Å—Ç–∏!\n"
            f"‚ö™Ô∏è –û–±—ã—á–Ω–∞—è ‚Üí üü¢ –ù–µ–æ–±—ã—á–Ω–∞—è ‚Üí üîµ –†–µ–¥–∫–∞—è ‚Üí üü£ –≠–ø–∏—á–µ—Å–∫–∞—è ‚Üí üü° –ú–∏—Ñ–∏—á–µ—Å–∫–∞—è\n\n"
            f"–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
        )

        await self.safe_edit(update, welcome_text, InlineKeyboardMarkup(keyboard))

    async def generate_report(self) -> str:
        total_users = len(self.users_db)
        total_messages = sum(u.get("messages", 0) for u in self.users_db.values())
        total_rating = sum(u.get("rating", 0) for u in self.users_db.values())
        total_currency = sum(u.get("farm_currency", 0) for u in self.users_db.values())
        total_banned = len(self.banned_users)
        total_punishments = sum(len(p) for p in self.punishments_db.values())
        
        top_users = sorted(
            self.users_db.items(),
            key=lambda x: x[1].get("rating", 0),
            reverse=True
        )[:5]
        
        top_text = "\n".join([
            f"{i+1}. {data.get('first_name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')} (ID: {uid}): {data.get('rating', 0)}‚≠êÔ∏è"
            for i, (uid, data) in enumerate(top_users)
        ])
        
        report = f"""
üìä –û–¢–ß–ï–¢ –ë–û–¢–ê
üìÖ –î–∞—Ç–∞: {datetime.now().strftime('%d.%m.%Y %H:%M')}

üë• –û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:
‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {total_users}
‚Ä¢ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: {total_banned}
‚Ä¢ –°–æ–æ–±—â–µ–Ω–∏–π: {total_messages}
‚Ä¢ –í—Å–µ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞: {total_rating}‚≠êÔ∏è
‚Ä¢ –í—Å–µ–≥–æ –≤–∞–ª—é—Ç—ã: {total_currency}üåΩ
‚Ä¢ –ù–∞–∫–∞–∑–∞–Ω–∏–π: {total_punishments}

üèÜ –¢–û–ü-5 –ü–û –†–ï–ô–¢–ò–ù–ì–£:
{top_text}

‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò:
‚Ä¢ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: —Ä–∞–∑ –≤ {SAVE_INTERVAL} —Å–æ–æ–±—â–µ–Ω–∏–π
‚Ä¢ –ñ–∏–≤–æ—Ç–Ω—ã—Ö: {len(ANIMALS)} –≤–∏–¥–∞
‚Ä¢ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–π: {len(FARM_ACHIEVEMENTS)}
‚Ä¢ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤: {len(ADMIN_IDS)}
"""
        return report

    async def send_email_report(self, update: Update) -> None:
        if not EMAIL_CONFIG["sender_email"] or not EMAIL_CONFIG["sender_password"]:
            await self.safe_edit(update, "‚ùå Email –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –£–∫–∞–∂–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è SENDER_EMAIL –∏ SENDER_PASSWORD.", self.get_back_button("admin"))
            return
            
        try:
            report_text = await self.generate_report()
            
            msg = MIMEMultipart()
            msg['From'] = EMAIL_CONFIG["sender_email"]
            msg['To'] = EMAIL_CONFIG["recipient_email"]
            msg['Subject'] = f"–û—Ç—á–µ—Ç –±–æ—Ç–∞ –æ—Ç {datetime.now().strftime('%d.%m.%Y')}"
            
            msg.attach(MIMEText(report_text, 'plain', 'utf-8'))
            
            context = ssl.create_default_context()
            with smtplib.SMTP(EMAIL_CONFIG["smtp_server"], EMAIL_CONFIG["smtp_port"]) as server:
                server.starttls(context=context)
                server.login(EMAIL_CONFIG["sender_email"], EMAIL_CONFIG["sender_password"])
                server.send_message(msg)
            
            await self.safe_edit(update, f"‚úÖ –û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ {EMAIL_CONFIG['recipient_email']}!", self.get_back_button("admin"))
            logger.info(f"–û—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ {EMAIL_CONFIG['recipient_email']}")
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email: {e}")
            await self.safe_edit(update, f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á–µ—Ç–∞: {str(e)}", self.get_back_button("admin"))

    async def show_admin_menu(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        if not await self.check_admin(update):
            return

        keyboard = [
            [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="admin_stats")],
            [InlineKeyboardButton("üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏", callback_data="admin_users_menu")],
            [InlineKeyboardButton("‚öñÔ∏è –ù–∞–∫–∞–∑–∞–Ω–∏—è", callback_data="admin_punish_menu")],
            [InlineKeyboardButton("üí∞ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∞–ª—é—Ç–æ–π", callback_data="admin_currency_menu")],
            [InlineKeyboardButton("üö´ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞", callback_data="admin_ban_menu")],
            [InlineKeyboardButton("üìú –ò—Å—Ç–æ—Ä–∏—è –Ω–∞–∫–∞–∑–∞–Ω–∏–π", callback_data="admin_punish_history")],
            [InlineKeyboardButton("üìß –û—Ç—á–µ—Ç –Ω–∞ –ø–æ—á—Ç—É", callback_data="admin_report")],
            [InlineKeyboardButton("üîÑ –°–±—Ä–æ—Å —Ä–µ–π—Ç–∏–Ω–≥–∞", callback_data="admin_reset")],
            [InlineKeyboardButton("üîô –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main")]
        ]

        await self.safe_edit(update, "üëë –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", InlineKeyboardMarkup(keyboard))

    async def admin_report(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        if not await self.check_admin(update):
            return
            
        await self.safe_edit(update, "üìß –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–∞...\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.", None)
        await self.send_email_report(update)

    async def admin_stats(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        if not await self.check_admin(update):
            return

        total_users = len(self.users_db)
        total_messages = sum(u.get("messages", 0) for u in self.users_db.values())
        total_rating = sum(u.get("rating", 0) for u in self.users_db.values())
        total_currency = sum(u.get("farm_currency", 0) for u in self.users_db.values())
        total_banned = len(self.banned_users)
        total_punishments = sum(len(p) for p in self.punishments_db.values())
        
        text = (
            f"üìä –û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê\n\n"
            f"üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {total_users}\n"
            f"üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: {total_banned}\n"
            f"üí¨ –°–æ–æ–±—â–µ–Ω–∏–π: {total_messages}\n"
            f"‚≠êÔ∏è –í—Å–µ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞: {total_rating}\n"
            f"üí∞ –í—Å–µ–≥–æ –≤–∞–ª—é—Ç—ã: {total_currency}\n"
            f"‚öñÔ∏è –ù–∞–∫–∞–∑–∞–Ω–∏–π: {total_punishments}\n\n"
            f"‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏:\n"
            f"‚Ä¢ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: —Ä–∞–∑ –≤ {SAVE_INTERVAL} —Å–æ–æ–±—â–µ–Ω–∏–π\n"
            f"‚Ä¢ –ñ–∏–≤–æ—Ç–Ω—ã—Ö: {len(ANIMALS)} –≤–∏–¥–∞\n"
            f"‚Ä¢ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–π: {len(FARM_ACHIEVEMENTS)}"
        )

        await self.safe_edit(update, text, self.get_back_button("admin"))

    async def admin_users_menu(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        if not await self.check_admin(update):
            return

        keyboard = [
            [InlineKeyboardButton("üìã –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", callback_data="admin_users_list")],
            [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="admin")]
        ]
        await self.safe_edit(update, "üë• –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú–ò\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", InlineKeyboardMarkup(keyboard))

    async def admin_users_list(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        if not await self.check_admin(update):
            return

        text = "üë• –ü–û–°–õ–ï–î–ù–ò–ï 20 –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô:\n\n"
        sorted_users = sorted(self.users_db.items(), key=lambda x: x[1].get("last_active", 0), reverse=True)[:20]

        for i, (user_id, data) in enumerate(sorted_users, 1):
            name = data.get("first_name") or data.get("username") or "–ë–µ–∑ –∏–º–µ–Ω–∏"
            rating = data.get("rating", 0)
            currency = data.get("farm_currency", 0)
            messages = data.get("messages", 0)
            status = "üö´" if user_id in self.banned_users else "‚úÖ"
            text += f"{status} {i}. {name}\n   ID: {user_id} | ‚≠êÔ∏è {rating} | üåΩ {currency} | üí¨ {messages}\n"

        await self.safe_edit(update, text, self.get_back_button("admin_users_menu"))

    async def admin_punish_menu(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        if not await self.check_admin(update):
            return

        all_rules = self.get_all_rules()
        keyboard = []
        for rule_key, rule in all_rules.items():
            is_custom = "üÜï " if rule_key in self.custom_rules_db else ""
            keyboard.append([InlineKeyboardButton(f"{is_custom}{rule['name']} (-{rule['penalty']}‚≠êÔ∏è)", callback_data=f"punish_select_{rule_key}")])
        
        keyboard.append([InlineKeyboardButton("‚ûï –°–æ–∑–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª–æ", callback_data="admin_add_rule")])
        keyboard.append([InlineKeyboardButton("‚ûñ –£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ", callback_data="admin_remove_rule")])
        keyboard.append([InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="admin")])

        await self.safe_edit(update, "‚öñÔ∏è –í–´–ë–ï–†–ò–¢–ï –ù–ê–†–£–®–ï–ù–ò–ï\n\n–ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –≤–≤–µ—Å—Ç–∏ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", InlineKeyboardMarkup(keyboard))

    async def admin_currency_menu(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        if not await self.check_admin(update):
            return

        keyboard = [
            [InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª—é—Ç—É", callback_data="admin_add_currency")],
            [InlineKeyboardButton("‚ûñ –ó–∞–±—Ä–∞—Ç—å –≤–∞–ª—é—Ç—É", callback_data="admin_remove_currency")],
            [InlineKeyboardButton("‚≠êÔ∏è –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–π—Ç–∏–Ω–≥", callback_data="admin_add_rating")],
            [InlineKeyboardButton("üí´ –ó–∞–±—Ä–∞—Ç—å —Ä–µ–π—Ç–∏–Ω–≥", callback_data="admin_remove_rating")],
            [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="admin")]
        ]

        await self.safe_edit(update, "üí∞ –£–ü–†–ê–í–õ–ï–ù–ò–ï –í–ê–õ–Æ–¢–û–ô\n\n–ö—É—Ä—Å: 10üåΩ = 1‚≠êÔ∏è\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", InlineKeyboardMarkup(keyboard))

    async def admin_ban_menu(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        if not await self.check_admin(update):
            return

        keyboard = [
            [InlineKeyboardButton("üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å", callback_data="admin_ban_user")],
            [InlineKeyboardButton("‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å", callback_data="admin_unban_user")],
            [InlineKeyboardButton("üìã –°–ø–∏—Å–æ–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö", callback_data="admin_banned_list")],
            [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="admin")]
        ]

        await self.safe_edit(update, "üö´ –ë–õ–û–ö–ò–†–û–í–ö–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", InlineKeyboardMarkup(keyboard))

    async def admin_punish_history(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        if not await self.check_admin(update):
            return

        if not self.punishments_db:
            await self.safe_edit(update, "üìú –ò—Å—Ç–æ—Ä–∏—è –Ω–∞–∫–∞–∑–∞–Ω–∏–π –ø—É—Å—Ç–∞", self.get_back_button("admin"))
            return

        text = "üìú –ü–û–°–õ–ï–î–ù–ò–ï –ù–ê–ö–ê–ó–ê–ù–ò–Ø:\n\n"
        all_punishments = []
        for user_id, punishments in self.punishments_db.items():
            for p in punishments:
                all_punishments.append((user_id, p))
        all_punishments.sort(key=lambda x: x[1]['date'], reverse=True)

        for user_id, p in all_punishments[:15]:
            user_info = self.users_db.get(user_id, {})
            name = user_info.get("first_name") or user_info.get("username") or f"ID {user_id}"
            date = datetime.fromisoformat(p['date']).strftime("%d.%m.%Y %H:%M")
            text += f"üë§ {name}\nüìÖ {date}\n‚öñÔ∏è {p['rule_name']} (-{p['penalty']}‚≠êÔ∏è)\nüëÆ –ê–¥–º–∏–Ω ID: {p['admin_id']}\n‚≠êÔ∏è {p['previous_rating']} ‚Üí {p['new_rating']}\n\n"

        await self.safe_edit(update, text, self.get_back_button("admin"))

    async def admin_banned_list(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        if not await self.check_admin(update):
            return

        if not self.banned_users:
            await self.safe_edit(update, "üö´ –ù–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", self.get_back_button("admin_ban_menu"))
            return

        text = "üö´ –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ù–´–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò:\n\n"
        for user_id, ban_info in self.banned_users.items():
            user_info = self.users_db.get(user_id, {})
            name = user_info.get("first_name") or user_info.get("username") or f"ID {user_id}"
            reason = ban_info.get("reason", "–ù–µ —É–∫–∞–∑–∞–Ω–∞")
            date = ban_info.get("date", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
            text += f"üë§ {name}\n  ID: {user_id}\n  –ü—Ä–∏—á–∏–Ω–∞: {reason}\n  –î–∞—Ç–∞: {date}\n\n"

        await self.safe_edit(update, text, self.get_back_button("admin_ban_menu"))

    async def show_rating(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        user = update.effective_user
        if not user or self.is_banned(user.id):
            return

        self.init_user(user.id, user.username, user.first_name)
        user_data = self.users_db[str(user.id)]
        text = f"‚≠êÔ∏è {user.first_name}, –≤–∞—à —Ä–µ–π—Ç–∏–Ω–≥: {user_data['rating']}\nüí∞ –í–∞–ª—é—Ç–∞ —Ñ–µ—Ä–º—ã: {user_data['farm_currency']} üåΩ\n\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\nüí¨ –°–æ–æ–±—â–µ–Ω–∏–π: {user_data['messages']}\nüí± –í—Å–µ–≥–æ –æ–±–º–µ–Ω—è–Ω–æ: {user_data['total_exchanged']} üåΩ\n‚öñÔ∏è –ù–∞–∫–∞–∑–∞–Ω–∏–π: {user_data.get('total_punishments', 0)}"
        await self.safe_edit(update, text, self.get_back_button())

    async def show_farm_menu(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        user = update.effective_user
        if not user or self.is_banned(user.id):
            return

        self.init_user(user.id, user.username, user.first_name)
        user_id = str(user.id)
        income = self.calculate_income(user_id)
        
        text = f"üåæ –ú–û–Ø –§–ï–†–ú–ê\n\nüí∞ –í–∞–ª—é—Ç–∞: {self.users_db[user_id]['farm_currency']} üåΩ\n‚è± –î–æ—Ö–æ–¥ –≤ —á–∞—Å: {income} üåΩ\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
        keyboard = [
            [InlineKeyboardButton("üé≤ –ö—É–ø–∏—Ç—å –∂–∏–≤–æ—Ç–Ω–æ–µ (10üåΩ)", callback_data="buy_animal")],
            [InlineKeyboardButton("üì¶ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å", callback_data="inventory")],
            [InlineKeyboardButton("üí± –û–±–º–µ–Ω—è—Ç—å –Ω–∞ —Ä–µ–π—Ç–∏–Ω–≥", callback_data="exchange")],
            [InlineKeyboardButton("üåæ –°–æ–±—Ä–∞—Ç—å –¥–æ—Ö–æ–¥", callback_data="collect_income")],
            [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="back_to_main")]
        ]
        await self.safe_edit(update, text, InlineKeyboardMarkup(keyboard))

    async def buy_animal(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        user = update.effective_user
        if not user or self.is_banned(user.id):
            return

        user_id = str(user.id)
        cost = 10

        if self.users_db[user_id]['farm_currency'] < cost:
            await self.safe_edit(update, f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–∞–ª—é—Ç—ã! –ù—É–∂–Ω–æ: {cost}üåΩ", self.get_back_button("farm"))
            return

        animal_type = random.choice(list(ANIMALS.keys()))
        rarity = self.get_rarity(animal_type)
        
        if animal_type not in self.animals_db[user_id]["inventory"]:
            self.animals_db[user_id]["inventory"][animal_type] = {"count": 0, "by_rarity": {}}
        
        self.animals_db[user_id]["inventory"][animal_type]["count"] += 1
        rarity_count = self.animals_db[user_id]["inventory"][animal_type]["by_rarity"].get(rarity, 0)
        self.animals_db[user_id]["inventory"][animal_type]["by_rarity"][rarity] = rarity_count + 1
        self.users_db[user_id]['farm_currency'] -= cost
        
        new_achievements = await self.check_animal_achievements(user_id)
        asyncio.create_task(self.save_all_async())
        
        color = RARITY_COLORS[rarity]
        animal_info = ANIMALS[animal_type]
        
        text = f"‚úÖ –í—ã –∫—É–ø–∏–ª–∏ –∂–∏–≤–æ—Ç–Ω–æ–µ!\n\n{color} {animal_info['name']}\n‚ú® –†–µ–¥–∫–æ—Å—Ç—å: {rarity}\nüí∞ –î–æ—Ö–æ–¥: {animal_info['base_income'] * RARITY_MULTIPLIERS[rarity]}üåΩ/—á–∞—Å\n\n–ü–æ—Ç—Ä–∞—á–µ–Ω–æ: {cost}üåΩ"
        
        if new_achievements:
            text += "\n\nüèÜ –ù–û–í–´–ï –î–û–°–¢–ò–ñ–ï–ù–ò–Ø:\n" + "\n".join(f"‚Ä¢ {FARM_ACHIEVEMENTS[ach]['name']} +{FARM_ACHIEVEMENTS[ach]['reward']}‚≠êÔ∏è" for ach in new_achievements)

        await self.safe_edit(update, text, self.get_back_button("farm"))

    async def check_animal_achievements(self, user_id: str) -> list:
        user_achievements = self.achievements_db[user_id].get("completed", [])
        new_achievements = []
        
        total_animals = 0
        rare_count = epic_count = mythic_count = 0
        unique_types = set()
        
        inventory = self.animals_db[user_id].get("inventory", {})
        for animal_type, data in inventory.items():
            for rarity, count in data.get("by_rarity", {}).items():
                total_animals += count
                if count > 0:
                    unique_types.add(animal_type)
                if rarity == "–†–µ–¥–∫–∞—è":
                    rare_count += count
                elif rarity == "–≠–ø–∏—á–µ—Å–∫–∞—è":
                    epic_count += count
                elif rarity == "–ú–∏—Ñ–∏—á–µ—Å–∫–∞—è":
                    mythic_count += count
        
        checks = [
            (total_animals >= 1, "first_animal"),
            (total_animals >= 5, "five_animals"),
            (total_animals >= 10, "ten_animals"),
            (total_animals >= 20, "twenty_animals"),
            (rare_count >= 3, "rare_collector"),
            (epic_count >= 2, "epic_collector"),
            (mythic_count >= 1, "mythic_collector"),
            (len(unique_types) >= 3, "full_house")
        ]
        
        for condition, ach_id in checks:
            if condition and ach_id not in user_achievements:
                new_achievements.append(ach_id)
                self.users_db[user_id]["rating"] += FARM_ACHIEVEMENTS[ach_id]["reward"]
        
        if new_achievements:
            user_achievements.extend(new_achievements)
            self.achievements_db[user_id]["completed"] = user_achievements
        
        return new_achievements

    async def show_inventory(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        user = update.effective_user
        if not user or self.is_banned(user.id):
            return

        user_id = str(user.id)
        if user_id not in self.animals_db or not self.animals_db[user_id]["inventory"]:
            await self.safe_edit(update, "üì¶ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç\n\n–ö—É–ø–∏—Ç–µ –∂–∏–≤–æ—Ç–Ω—ã—Ö –≤ —Ñ–µ—Ä–º–µ!", self.get_back_button("farm"))
            return

        text = "üì¶ –í–ê–® –ò–ù–í–ï–ù–¢–ê–†–¨:\n\n"
        total_animals = 0
        by_rarity = {r: 0 for r in RARITY_MULTIPLIERS.keys()}
        
        for animal_type, data in self.animals_db[user_id]["inventory"].items():
            animal_name = ANIMALS[animal_type]["emoji"]
            text += f"\n{animal_name}:\n"
            for rarity, count in data.get("by_rarity", {}).items():
                if count > 0:
                    text += f"  {RARITY_COLORS[rarity]} {rarity}: {count}\n"
                    by_rarity[rarity] += count
                    total_animals += count
        
        text += f"\nüìä –í–°–ï–ì–û –ñ–ò–í–û–¢–ù–´–•: {total_animals}\n"
        for rarity, count in by_rarity.items():
            text += f"{RARITY_COLORS[rarity]} {rarity}: {count}\n"

        await self.safe_edit(update, text, self.get_back_button("farm"))

    async def collect_income(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        user = update.effective_user
        if not user or self.is_banned(user.id):
            return

        user_id = str(user.id)
        last_collect = self.animals_db[user_id].get("last_collect")
        now = datetime.now()
        
        if last_collect:
            last = datetime.fromtimestamp(last_collect)
            if (now - last).total_seconds() < 3600:
                remaining = int(3600 - (now - last).total_seconds()) // 60
                await self.safe_edit(update, f"‚ùå –î–æ —Å–±–æ—Ä–∞ –æ—Å—Ç–∞–ª–æ—Å—å: {remaining} –º–∏–Ω—É—Ç", self.get_back_button("farm"))
                return
        
        income = self.calculate_income(user_id)
        self.users_db[user_id]['farm_currency'] += income
        self.animals_db[user_id]["last_collect"] = now.timestamp()
        asyncio.create_task(self.save_all_async())
        
        await self.safe_edit(update, f"‚úÖ –í—ã —Å–æ–±—Ä–∞–ª–∏ –¥–æ—Ö–æ–¥: +{income}üåΩ\nüí∞ –¢–µ–ø–µ—Ä—å —É –≤–∞—Å: {self.users_db[user_id]['farm_currency']}üåΩ", self.get_back_button("farm"))

    async def exchange_currency(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        user = update.effective_user
        if not user or self.is_banned(user.id):
            return

        user_id = str(user.id)
        currency = self.users_db[user_id]['farm_currency']
        
        if currency < 10:
            await self.safe_edit(update, "‚ùå –ú–∏–Ω–∏–º—É–º –¥–ª—è –æ–±–º–µ–Ω–∞: 10üåΩ", self.get_back_button("farm"))
            return
        
        rating_gain = currency // 10
        amount = rating_gain * 10
        
        self.users_db[user_id]['farm_currency'] -= amount
        self.users_db[user_id]['rating'] += rating_gain
        self.users_db[user_id]['total_exchanged'] += amount
        asyncio.create_task(self.save_all_async())
        
        await self.safe_edit(update, f"‚úÖ –û–±–º–µ–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω!\nüí± {amount}üåΩ ‚Üí +{rating_gain}‚≠êÔ∏è\n\nüí∞ –û—Å—Ç–∞–ª–æ—Å—å: {self.users_db[user_id]['farm_currency']}üåΩ\n‚≠êÔ∏è –†–µ–π—Ç–∏–Ω–≥: {self.users_db[user_id]['rating']}", self.get_back_button("farm"))

    async def show_achievements(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        user = update.effective_user
        if not user or self.is_banned(user.id):
            return

        user_id = str(user.id)
        completed = self.achievements_db[user_id].get("completed", [])
        
        text = "üèÜ –î–û–°–¢–ò–ñ–ï–ù–ò–Ø –§–ï–†–ú–´:\n\n"
        for ach_id, ach_data in FARM_ACHIEVEMENTS.items():
            status = "‚úÖ" if ach_id in completed else "‚ùå"
            text += f"{status} {ach_data['name']}: {ach_data['desc']} (+{ach_data['reward']}‚≠êÔ∏è)\n"

        await self.safe_edit(update, text, self.get_back_button("main"))

    async def daily_bonus(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        user = update.effective_user
        if not user or self.is_banned(user.id):
            return

        user_id = str(user.id)
        user_data = self.users_db[user_id]
        last_bonus = user_data.get("daily_bonus")
        now = datetime.now()

        if last_bonus and datetime.fromtimestamp(last_bonus).date() == now.date():
            await self.safe_edit(update, "‚ùå –í—ã —É–∂–µ –ø–æ–ª—É—á–∞–ª–∏ –±–æ–Ω—É—Å —Å–µ–≥–æ–¥–Ω—è! –ü—Ä–∏—Ö–æ–¥–∏—Ç–µ –∑–∞–≤—Ç—Ä–∞.", self.get_back_button("main"))
            return

        bonus = random.randint(2, 10)
        user_data["rating"] += bonus
        user_data["daily_bonus"] = now.timestamp()
        asyncio.create_task(self.save_all_async())
        await self.safe_edit(update, f"üí∞ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å: +{bonus}‚≠êÔ∏è!", self.get_back_button("main"))

    async def admin_add_currency(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        if not await self.check_admin(update):
            return
        self.pending_actions[str(update.effective_user.id)] = {"action": "add_currency", "step": "waiting_for_id"}
        await self.safe_edit(update, "üí∞ –î–û–ë–ê–í–õ–ï–ù–ò–ï –í–ê–õ–Æ–¢–´\n\n–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", self.get_back_button("admin_currency_menu"))

    async def admin_remove_currency(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        if not await self.check_admin(update):
            return
        self.pending_actions[str(update.effective_user.id)] = {"action": "remove_currency", "step": "waiting_for_id"}
        await self.safe_edit(update, "üí∞ –ó–ê–ë–û–† –í–ê–õ–Æ–¢–´\n\n–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", self.get_back_button("admin_currency_menu"))

    async def admin_add_rating(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        if not await self.check_admin(update):
            return
        self.pending_actions[str(update.effective_user.id)] = {"action": "add_rating", "step": "waiting_for_id"}
        await self.safe_edit(update, "‚≠êÔ∏è –î–û–ë–ê–í–õ–ï–ù–ò–ï –†–ï–ô–¢–ò–ù–ì–ê\n\n–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", self.get_back_button("admin_currency_menu"))

    async def admin_remove_rating(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        if not await self.check_admin(update):
            return
        self.pending_actions[str(update.effective_user.id)] = {"action": "remove_rating", "step": "waiting_for_id"}
        await self.safe_edit(update, "‚≠êÔ∏è –ó–ê–ë–û–† –†–ï–ô–¢–ò–ù–ì–ê\n\n–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", self.get_back_button("admin_currency_menu"))

    async def admin_ban_user(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        if not await self.check_admin(update):
            return
        self.pending_actions[str(update.effective_user.id)] = {"action": "ban_user", "step": "waiting_for_id"}
        await self.safe_edit(update, "üö´ –ë–õ–û–ö–ò–†–û–í–ö–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø\n\n–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:", self.get_back_button("admin_ban_menu"))

    async def admin_unban_user(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        if not await self.check_admin(update):
            return
        self.pending_actions[str(update.effective_user.id)] = {"action": "unban_user", "step": "waiting_for_id"}
        await self.safe_edit(update, "‚úÖ –†–ê–ó–ë–õ–û–ö–ò–†–û–í–ö–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø\n\n–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:", self.get_back_button("admin_ban_menu"))

    async def admin_add_rule_start(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        if not await self.check_admin(update):
            return
        self.pending_actions[str(update.effective_user.id)] = {"action": "add_rule", "step": "waiting_for_key"}
        await self.safe_edit(update, "‚ûï –î–û–ë–ê–í–õ–ï–ù–ò–ï –ü–†–ê–í–ò–õ–ê\n\n–í–≤–µ–¥–∏—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á (–ª–∞—Ç–∏–Ω–∏—Ü–µ–π, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤):", self.get_back_button("admin_punish_menu"))

    async def admin_remove_rule_start(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        if not await self.check_admin(update):
            return
        if not self.custom_rules_db:
            await self.safe_edit(update, "‚ùå –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–∞–≤–∏–ª –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è!", self.get_back_button("admin_punish_menu"))
            return

        text = "‚ûñ –£–î–ê–õ–ï–ù–ò–ï –ü–†–ê–í–ò–õ–ê\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞:\n" + "\n".join(f"‚Ä¢ {key}: {rule['name']} (-{rule['penalty']}‚≠êÔ∏è)" for key, rule in self.custom_rules_db.items()) + "\n\n–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:"
        self.pending_actions[str(update.effective_user.id)] = {"action": "remove_rule", "step": "waiting_for_key"}
        await self.safe_edit(update, text, self.get_back_button("admin_punish_menu"))

    async def admin_reset(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        if not await self.check_admin(update):
            return

        keyboard = InlineKeyboardMarkup([[
            InlineKeyboardButton("‚úÖ –î–∞, —Å–±—Ä–æ—Å–∏—Ç—å", callback_data="admin_reset_confirm"),
            InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="admin")
        ]])
        await self.safe_edit(update, "‚ö†Ô∏è –°–±—Ä–æ—Å–∏—Ç—å —Ä–µ–π—Ç–∏–Ω–≥ –í–°–ï–• –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!", keyboard)

    async def admin_reset_confirm(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        if not await self.check_admin(update):
            return

        for user_id in self.users_db:
            self.users_db[user_id]["rating"] = 0
        asyncio.create_task(self.save_all_async())
        await self.safe_edit(update, "‚úÖ –†–µ–π—Ç–∏–Ω–≥ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–±—Ä–æ—à–µ–Ω!", self.get_back_button("admin"))

    async def handle_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        user = update.effective_user
        if not user or not update.message or self.is_banned(user.id):
            return

        user_id = str(user.id)
        text = update.message.text.strip()

        if user_id in self.pending_actions:
            action_data = self.pending_actions[user_id]
            action, step = action_data["action"], action_data["step"]

            if action == "add_currency" and step == "waiting_for_id":
                action_data["target_id"], action_data["step"] = text, "waiting_for_amount"
                await self.safe_edit(update, f"üí∞ –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {text}:", self.get_back_button("admin_currency_menu"))
                return
            elif action == "add_currency" and step == "waiting_for_amount":
                try:
                    amount, target_id = int(text), action_data["target_id"]
                    self.init_user(int(target_id))
                    self.users_db[target_id]["farm_currency"] += amount
                    asyncio.create_task(self.save_all_async())
                    await self.safe_edit(update, f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ {amount}üåΩ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {self.users_db[target_id].get('first_name', target_id)}", self.get_back_button("admin_currency_menu"))
                except ValueError:
                    await self.safe_edit(update, "‚ùå –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ!", self.get_back_button("admin_currency_menu"))
                del self.pending_actions[user_id]
                return

            elif action == "remove_currency" and step == "waiting_for_id":
                action_data["target_id"], action_data["step"] = text, "waiting_for_amount"
                await self.safe_edit(update, f"üí∞ –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –∑–∞–±–æ—Ä–∞ —É {text}:", self.get_back_button("admin_currency_menu"))
                return
            elif action == "remove_currency" and step == "waiting_for_amount":
                try:
                    amount, target_id = int(text), action_data["target_id"]
                    if target_id in self.users_db:
                        self.users_db[target_id]["farm_currency"] = max(0, self.users_db[target_id].get("farm_currency", 0) - amount)
                        asyncio.create_task(self.save_all_async())
                        await self.safe_edit(update, f"‚úÖ –ó–∞–±—Ä–∞–Ω–æ {amount}üåΩ —É {self.users_db[target_id].get('first_name', target_id)}", self.get_back_button("admin_currency_menu"))
                    else:
                        await self.safe_edit(update, "‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω!", self.get_back_button("admin_currency_menu"))
                except ValueError:
                    await self.safe_edit(update, "‚ùå –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ!", self.get_back_button("admin_currency_menu"))
                del self.pending_actions[user_id]
                return

            elif action == "add_rating" and step == "waiting_for_id":
                action_data["target_id"], action_data["step"] = text, "waiting_for_amount"
                await self.safe_edit(update, f"‚≠êÔ∏è –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–π—Ç–∏–Ω–≥–∞ –¥–ª—è {text}:", self.get_back_button("admin_currency_menu"))
                return
            elif action == "add_rating" and step == "waiting_for_amount":
                try:
                    amount, target_id = int(text), action_data["target_id"]
                    self.init_user(int(target_id))
                    self.users_db[target_id]["rating"] += amount
                    asyncio.create_task(self.save_all_async())
                    await self.safe_edit(update, f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ {amount}‚≠êÔ∏è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {self.users_db[target_id].get('first_name', target_id)}", self.get_back_button("admin_currency_menu"))
                except ValueError:
                    await self.safe_edit(update, "‚ùå –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ!", self.get_back_button("admin_currency_menu"))
                del self.pending_actions[user_id]
                return

            elif action == "remove_rating" and step == "waiting_for_id":
                action_data["target_id"], action_data["step"] = text, "waiting_for_amount"
                await self.safe_edit(update, f"‚≠êÔ∏è –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–π—Ç–∏–Ω–≥–∞ –¥–ª—è –∑–∞–±–æ—Ä–∞ —É {text}:", self.get_back_button("admin_currency_menu"))
                return
            elif action == "remove_rating" and step == "waiting_for_amount":
                try:
                    amount, target_id = int(text), action_data["target_id"]
                    if target_id in self.users_db:
                        self.users_db[target_id]["rating"] = max(0, self.users_db[target_id].get("rating", 0) - amount)
                        asyncio.create_task(self.save_all_async())
                        await self.safe_edit(update, f"‚úÖ –ó–∞–±—Ä–∞–Ω–æ {amount}‚≠êÔ∏è —É {self.users_db[target_id].get('first_name', target_id)}", self.get_back_button("admin_currency_menu"))
                    else:
                        await self.safe_edit(update, "‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω!", self.get_back_button("admin_currency_menu"))
                except ValueError:
                    await self.safe_edit(update, "‚ùå –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ!", self.get_back_button("admin_currency_menu"))
                del self.pending_actions[user_id]
                return

            elif action == "ban_user" and step == "waiting_for_id":
                target_id = text
                if target_id in self.users_db:
                    self.banned_users[target_id] = {"date": datetime.now().isoformat(), "reason": "–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª", "admin_id": user.id}
                    asyncio.create_task(self.save_all_async())
                    await self.safe_edit(update, f"üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {self.users_db[target_id].get('first_name', target_id)} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!", self.get_back_button("admin_ban_menu"))
                else:
                    await self.safe_edit(update, "‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω!", self.get_back_button("admin_ban_menu"))
                del self.pending_actions[user_id]
                return

            elif action == "unban_user" and step == "waiting_for_id":
                target_id = text
                if target_id in self.banned_users:
                    del self.banned_users[target_id]
                    asyncio.create_task(self.save_all_async())
                    await self.safe_edit(update, f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {self.users_db.get(target_id, {}).get('first_name', target_id)} —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!", self.get_back_button("admin_ban_menu"))
                else:
                    await self.safe_edit(update, "‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö!", self.get_back_button("admin_ban_menu"))
                del self.pending_actions[user_id]
                return

        self.init_user(user.id, user.username, user.first_name)
        user_data = self.users_db[user_id]
        user_data["messages"] += 1
        user_data["last_active"] = datetime.now().timestamp()

        if not self.is_admin(user.id):
            user_data["rating"] += random.randint(1, 3)

        if user_data["messages"] % SAVE_INTERVAL == 0:
            asyncio.create_task(self.save_all_async())

    async def button_handler(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        query = update.callback_query
        await query.answer()
        data = query.data

        handlers = {
            "back_to_main": self.show_main_menu,
            "back_to_farm": self.show_farm_menu,
            "rating": self.show_rating,
            "farm": self.show_farm_menu,
            "daily_bonus": self.daily_bonus,
            "achievements": self.show_achievements,
            "buy_animal": self.buy_animal,
            "inventory": self.show_inventory,
            "collect_income": self.collect_income,
            "exchange": self.exchange_currency,
            "admin": self.show_admin_menu,
            "admin_stats": self.admin_stats,
            "admin_users_menu": self.admin_users_menu,
            "admin_users_list": self.admin_users_list,
            "admin_punish_menu": self.admin_punish_menu,
            "admin_currency_menu": self.admin_currency_menu,
            "admin_ban_menu": self.admin_ban_menu,
            "admin_punish_history": self.admin_punish_history,
            "admin_banned_list": self.admin_banned_list,
            "admin_add_currency": self.admin_add_currency,
            "admin_remove_currency": self.admin_remove_currency,
            "admin_add_rating": self.admin_add_rating,
            "admin_remove_rating": self.admin_remove_rating,
            "admin_ban_user": self.admin_ban_user,
            "admin_unban_user": self.admin_unban_user,
            "admin_add_rule": self.admin_add_rule_start,
            "admin_remove_rule": self.admin_remove_rule_start,
            "admin_report": self.admin_report,
            "admin_reset": self.admin_reset,
            "admin_reset_confirm": self.admin_reset_confirm
        }

        if data in handlers:
            await handlers[data](update, context)
        elif data.startswith("punish_select_"):
            rule_key = data.replace("punish_select_", "")
            context.user_data['selected_rule'] = rule_key
            await self.safe_edit(update, f"‚öñÔ∏è –í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –Ω–∞–∫–∞–∑–∞–Ω–∏—è:", self.get_back_button("admin_punish_menu"))
        else:
            await query.message.edit_text("‚è≥ –§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ", reply_markup=self.get_back_button("main"))

def main() -> None:
    if not BOT_TOKEN:
        print("‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–∫–∞–∑–∞–Ω BOT_TOKEN –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!")
        return
    
    bot = SocialRatingBot()
    application = Application.builder().token(BOT_TOKEN).build()
    
    application.add_handler(CommandHandler("start", bot.show_main_menu))
    application.add_handler(CommandHandler("menu", bot.show_main_menu))
    application.add_handler(CallbackQueryHandler(bot.button_handler))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, bot.handle_message))
    
    print("ü§ñ –ë–æ—Ç —Å —Ñ–µ—Ä–º–æ–π –∏ –∂–∏–≤–æ—Ç–Ω—ã–º–∏ –∑–∞–ø—É—â–µ–Ω!")
    print(f"üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã: {ADMIN_IDS}")
    print(f"üêæ –ñ–∏–≤–æ—Ç–Ω—ã–µ: {len(ANIMALS)} –≤–∏–¥–∞")
    print(f"üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: —Ä–∞–∑ –≤ {SAVE_INTERVAL} —Å–æ–æ–±—â–µ–Ω–∏–π")
    if EMAIL_CONFIG["sender_email"]:
        print(f"üìß –û—Ç—á–µ—Ç—ã: –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã")
    else:
        print(f"üìß –û—Ç—á–µ—Ç—ã: –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã (—É–∫–∞–∂–∏—Ç–µ SENDER_EMAIL)")
    
    application.run_polling()

if __name__ == "__main__":
    main()